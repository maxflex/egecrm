// Generated by CoffeeScript 1.9.3
angular.module("Task", ['ngSanitize']).filter('reverse', function() {
  return function(items) {
    if (items) {
      return items.slice().reverse();
    }
  };
}).controller("ListCtrl", function($scope) {
  $scope.editing_tasks = [];
  $scope.editTask = function(Task) {
    $scope.editing_task = Task.id;
    $scope.old_html = Task.html;
    if (typeof this.e === "object") {
      $scope.e.destroy();
    }
    $scope.e = CKEDITOR.replace("task-" + Task.id, {
      language: 'ru',
      height: 500,
      title: "testy",
      extraPlugins: 'pastebase64'
    });
    $scope.e.setData(Task.html);
    $scope.e.on('contentDom', function() {
      return $scope.e.document.on('keydown', function(event) {
        event = event.data.$;
        if (event.which === 13 && (event.ctrlKey || event.metaKey) || (event.which === 19)) {
          Task.html = $scope.e.getData();
          $scope.e.destroy();
          delete $scope.e;
          $scope.$apply();
          $scope.saveTask(Task);
        }
        if (event.which === 27) {
          Task.html += " ";
          $scope.e.destroy();
          delete $scope.e;
          return $scope.$apply();
        }
      });
    });
    $scope.e.on('instanceReady', function(event) {
      $scope.e.focus().select;
      return $scope.e.execCommand('selectAll');
    });
    return $scope.e.on('blur', function(event) {
      Task.html += " ";
      $scope.e.destroy();
      delete $scope.e;
      return $scope.$apply();
    });
  };
  $scope.editingTask = function(Task) {
    return Task.id === $scope.editing_task;
  };
  $scope.addTask = function() {
    return $.post("tasks/ajax/add", {}, function(id_task) {
      var Task;
      Task = {
        id: id_task,
        id_status: 1,
        html: "Текст задачи..."
      };
      $scope.Tasks.push(Task);
      $scope.$apply();
      return $scope.editTask(Task);
    });
  };
  $scope.saveTask = function(Task) {
    return $.post("tasks/ajax/save", {
      Task: Task
    });
  };
  return $(document).ready(function() {
    return set_scope('Task');
  });
});
