// Generated by CoffeeScript 1.9.3
var vueInit;

$(document).ready(function() {
  var vm;
  vm = vueInit();
  return $(window).on("beforeunload", function() {
    return vm.savePopupData();
  });
});

vueInit = function() {
  Vue.config.debug = true;
  Vue.config.async = false;
  Vue.component('phone', {
    props: ['user_id'],
    data: function() {
      return {
        show_element: false,
        hide_element: false,
        connected: false,
        determined: false,
        timer: {
          hide_timeout: void 0,
          interval: void 0,
          diff: 0
        },
        mango: {},
        caller: false
      };
    },
    template: '#phone-template',
    methods: {
      hangup: function() {
        $.post('mango/hangup', {
          call_id: this.mango.call_id
        });
        return this.endCall();
      },
      callAppeared: function() {
        this.show_element = true;
        this.determined = false;
        this.caller = false;
        return $.post('mango/getCaller', {
          phone: this.mango.from.number
        }, (function(_this) {
          return function(request) {
            _this.caller = request;
            _this.determined = true;
            return _this.setHideTimeout();
          };
        })(this), 'json');
      },
      setHideTimeout: function(seconds) {
        if (!seconds) {
          seconds = 10;
        }
        if (this.timer.hide_timeout) {
          clearTimeout(this.timer.hide_timeout);
        }
        return this.timer.hide_timeout = setTimeout(this.endCall, seconds * 1000);
      },
      startCall: function() {
        this.connected = true;
        return this.timer.interval = setInterval((function(_this) {
          return function() {
            var now;
            now = Math.floor(Date.now() / 1000);
            _this.timer.diff = now - _this.mango.timestamp;
            return console.log(now, _this.mango.timestamp, _this.timer.diff);
          };
        })(this), 1000);
      },
      endCall: function() {
        if (this.connected) {
          clearInterval(this.timer.interval);
        }
        clearTimeout(this.timer.hide_timeout);
        this.show_element = false;
        this.hide_element = false;
        return this.connected = false;
      },
      saveState: function() {
        var answered_user, caller_type;
        answered_user = this.mango.to.extension;
        if (answered_user === this.user_id) {
          caller_type = this.caller.type ? this.caller.type : '';
          return $.post('mango/saveCallState', {
            phone: this.mango.from.number,
            user_id: this.user_id
          });
        }
      },
      savePopupData: function() {
        if (this.show_element) {
          return localStorage.setItem('popupData', JSON.stringify({
            show_element: this.show_element,
            number: this.mango.from.number,
            determined: this.determined,
            caller: this.caller,
            timestamp: this.mango.timestamp,
            mango: this.mango
          }));
        }
      },
      initPusher: function() {
        var channel, pusher;
        pusher = new Pusher('a9e10be653547b7106c0', {
          encrypted: true
        });
        channel = pusher.subscribe("user_" + this.user_id);
        channel.bind('incoming', (function(_this) {
          return function(data) {
            _this.mango = data;
            switch (data.call_state) {
              case 'Appeared':
                return _this.callAppeared();
              case 'Connected':
                _this.saveState();
                return _this.startCall();
              case 'Disconnected':
                return _this.endCall();
            }
          };
        })(this));
        return this.recoverPrevCall();
      },
      recoverPrevCall: function() {
        var popupData, secondsToShow;
        popupData = localStorage.getItem('popupData');
        if (popupData) {
          popupData = JSON.parse(popupData);
          this.caller = popupData.caller;
          this.determined = popupData.determined;
          this.mango = popupData.mango;
          secondsToShow = Math.floor(Date.now() / 1000) - popupData.timestamp;
          this.show_element = secondsToShow < 20;
          if (this.show_element) {
            this.setHideTimeout(20 - secondsToShow);
          }
          return localStorage.removeItem('popupData');
        }
      }
    },
    computed: {
      call_length: function() {
        return moment(parseInt(this.timer.diff) * 1000).format('mm:ss');
      },
      number: function() {
        return "+" + this.mango.from.number;
      }
    },
    ready: function() {
      return this.initPusher();
    }
  });
  return new Vue({
    el: '.phone-app',
    methods: {
      savePopupData: function() {
        return this.$children[0].savePopupData();
      }
    }
  });
};
