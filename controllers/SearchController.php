<?php	// Контроллер	class SearchController extends Controller	{		public $defaultAction = "search";		// Папка вьюх		protected $_viewsFolder	= "search";		/**		 * Поиск.		 *		 */		public function actionSearch()		{			extract($_POST);						$this->setTabTitle("Рультаты поиска по запросу «". $text. "»");			$this->addJs("ng-search-app");			# если пустой запрос			$text = trim($text);			$text = str_replace("-", "", $text); // удаляем все тире, чтобы искалось по номеру телефона и так, и так			if (empty($text)) {				$this->render("no_results");				return;			}						$Students = [];			$Teachers = [];						$result = dbConnection()->query("				SELECT id_student FROM search_students			    WHERE search_text LIKE '%$text%'			");						if ($result->num_rows) {				while ($row = $result->fetch_object()) {					$student_ids[] = $row->id_student;				}								$query = dbConnection()->query("					SELECT id, first_name, last_name, middle_name FROM students					WHERE id IN (". implode(",", $student_ids) .")				");								while ($row = $query->fetch_object()) {					$Students[] = $row;				}			}						$query_teachers = dbConnection()->query("				SELECT id, first_name, last_name, middle_name FROM teachers				WHERE in_egecentr = 1 AND (first_name LIKE '%$text%' OR					last_name LIKE '%$text%' OR					middle_name LIKE '%$text%' OR					phone LIKE '%$text%' OR					phone2 LIKE '%$text%' OR					phone3 LIKE '%$text%' OR					email LIKE '%$text%')			");						while ($row = $query_teachers->fetch_object()) {				$Teachers[] = $row;			}						if (!count($Students) && !count($Teachers)) {				$this->render("no_results");			} else {				// Если найден один ученик				if (!count($Teachers) && count($Students) == 1) {					$this->redirect("student/" . $Students[0]->id, true);				}				// Если найден один учитель				else if (!count($Students) && count($Teachers) == 1) {					$this->redirect("teachers/edit/" . $Teachers[0]->id, true);				} else {					$this->render("results", [						"Students" => $Students,						"Teachers" => $Teachers,					]);									}			}		}		private function _generateCondition($table, $text, $search_fields, &$sql)		{			foreach ($search_fields as &$search_field) {				$search_field = $table . "." . $search_field;			}			foreach ($search_fields as $search_field) {				$sql[] = "CONVERT($search_field USING utf8) LIKE '%$text%'";			}		}		##################################################		###################### AJAX ######################		##################################################	}