<?php	// Контроллер	class RatingController extends Controller	{		public $defaultAction = "rating";				// Папка вьюх		protected $_viewsFolder	= "rating";				public function actionRating()		{			$this->setTabTitle("Рейтинг филиалов");									$Students = Student::findAll([				"condition" => "branches != ''"			]);						foreach ($Students as &$Student) {				$Student->Contract = $Student->getLastContract();				foreach ($Student->branches as $id_branch) {					$rating[$id_branch]++;					if ($Student->Contract) {						$rating[$id_branch] += count($Student->Contract->subjects); 					}				}			}						asort($rating);			$rating = array_reverse($rating, true);						$this->render("rating", [				"rating" => $rating			]);		}				public function actionBranchRating()		{			$id_branch = $_GET['id_branch'];						$this->setTabTitle("Рейтинг филиала ".Branches::getById($id_branch));						// Актуальный рейтинг из договоров			$Students = Student::getWithContractByBranch($id_branch);						foreach ($Students as $Student) {				$Contracts = $Student->getActiveContracts();				foreach ($Contracts as $Contract) {					foreach ($Contract->subjects as $Subject) {						$id_subject = $Subject['id_subject'];						$result[$Contract->grade][$id_subject] += round(1 / count($Student->branches), 1);					}				}			}						// Прогнозируемый рейтинг из заявок			$Requests = Request::findAll([				"condition" => "id_branch=$id_branch AND id_status IN (" . RequestStatuses::AWAITING . "," . RequestStatuses::NOT_DECIDED .")",				"group"		=> "id_student",			]);						foreach ($Requests as $Request) {				foreach ($Request->subjects as $id_subject) {					$coef = $Request->id_status == RequestStatuses::AWAITING ? 0.5 : 0.25;					$result_prognoz[$Request->grade][$id_subject] += $coef;				}			}						foreach ($result_prognoz as &$prognoz) {				foreach ($prognoz as &$prognoz_data) {					$prognoz_data = round($prognoz_data, 1);				}			}						$this->render("branch_rating", [				"id_branch" 	=> $id_branch,				"result" 		=> $result,				"result_prognoz"=> $result_prognoz,			]);		}				##################################################		###################### AJAX ######################		##################################################							}